#!/bin/bash
# Pre-ship hook for Tiki.Desktop
# Bumps version only during release ship (not individual issue ship)
set -e

# Only bump version for release ships
if [ -z "$TIKI_RELEASE_VERSION" ]; then
    echo "Pre-ship: Skipping version bump (not a release ship)"
    exit 0
fi

echo "================================================"
echo "Pre-ship: Bumping version for release $TIKI_RELEASE_VERSION"
echo "================================================"

# Check if package.json exists
if [ ! -f "package.json" ]; then
    echo "Error: package.json not found"
    exit 1
fi

# Extract version number from release (v1.0.11 -> 1.0.11)
RELEASE_VERSION="${TIKI_RELEASE_VERSION#v}"
echo "Release version: $RELEASE_VERSION"

# Read current version
CURRENT=$(node -p "require('./package.json').version" 2>/dev/null)
echo "Current package.json version: $CURRENT"

# Check if already at correct version
if [ "$CURRENT" = "$RELEASE_VERSION" ]; then
    echo "Version already at $RELEASE_VERSION - no bump needed"
    exit 0
fi

# Update package.json to match release version
npm version "$RELEASE_VERSION" --no-git-tag-version --allow-same-version

# Stage the changed files for the ship commit
git add package.json package-lock.json

echo ""
echo "Version bumped: $CURRENT -> $RELEASE_VERSION"
echo "Files staged for commit: package.json, package-lock.json"
echo "================================================"
