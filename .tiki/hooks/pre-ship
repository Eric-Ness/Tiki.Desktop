#!/bin/bash
# Pre-ship hook for Tiki.Desktop
# Bumps version during release-ship (not individual issue ship)
set -e

echo "Pre-ship hook running..."

# Only bump version during release-ship (TIKI_RELEASE_VERSION is set)
if [ -z "$TIKI_RELEASE_VERSION" ]; then
    echo "Individual issue ship - skipping version bump"
    exit 0
fi

echo "================================================"
echo "Release ship detected: $TIKI_RELEASE_VERSION"
echo "================================================"

# Check if package.json exists
if [ ! -f "package.json" ]; then
    echo "Error: package.json not found"
    exit 1
fi

# Extract version number (v1.0.14 -> 1.0.14)
VERSION="${TIKI_RELEASE_VERSION#v}"
echo "Target version: $VERSION"

# Read current version
CURRENT=$(node -p "require('./package.json').version" 2>/dev/null)
echo "Current version: $CURRENT"

# Check if already at correct version
if [ "$CURRENT" = "$VERSION" ]; then
    echo "Version already at $VERSION - no bump needed"
    exit 0
fi

# Update package.json to match release version
npm version "$VERSION" --no-git-tag-version --allow-same-version

# Stage the changed files for the ship commit
git add package.json package-lock.json

echo ""
echo "Version bumped: $CURRENT -> $VERSION"
echo "Files staged: package.json, package-lock.json"
echo "================================================"
