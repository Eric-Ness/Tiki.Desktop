# Knowledge Synthesis on Ship

Auto-generate a knowledge entry synthesizing learnings from the completed issue.

**CRITICAL: This step should NEVER cause ship to fail.** All errors are warnings only.

## When to Skip

Skip knowledge capture silently if ANY of these apply:

1. **Too few phases** - Plan has fewer than `knowledge.minPhasesForCapture` phases (default: 1)
2. **Trivial/routine work** - All phases are standard implementation (CRUD, UI tweaks, config changes)
3. **No learnings discovered** - No assumption invalidations, workarounds, or ADRs created
4. **Simple bug fix** - Single-phase fix with obvious cause and solution
5. **Documentation-only** - Issue only modified docs/comments without code insights

## Synthesis Workflow

### 1. Read Plan Context

Load `.tiki/plans/issue-{N}.json` and extract:

- `issue.title` and `issue.labels`
- Phase summaries (from `phases[].summary` or execution history)
- Files modified (from `phases[].files`)
- Success criteria and which were challenging

### 2. Check for Significant Learnings

Look for indicators of valuable knowledge:

- **Assumption invalidations** - Approaches that didn't work
- **ADRs created** - Architecture decisions made (check `.tiki/adr/` for issue refs)
- **Multiple fix attempts** - Phases with retry/redo history
- **Unexpected discoveries** - DISCOVERED markers in phase summaries
- **KNOWLEDGE markers** - Already captured insights (may skip to avoid duplication)

If no significant learnings found, skip with message: "Knowledge capture skipped (routine implementation)"

### 3. Generate Entry Content

Synthesize a knowledge entry:

**Title:** Concise summary of key insight (5-10 words)
- Focus on the solution/approach, not the problem
- Start with noun or action verb: "PostgreSQL JSONB...", "Handling async..."

**Content:** Markdown summary (100-300 words) containing:
- Problem context (1-2 sentences)
- Solution approach and why it works
- Key files/patterns involved
- Gotchas or edge cases discovered

**Keywords:** Extract from:
- Issue labels (e.g., "bug", "enhancement" -> technology names)
- File paths (e.g., "src/auth/*.ts" -> "authentication", "typescript")
- Technologies used in implementation
- Pattern names (e.g., "retry-logic", "caching")

**Confidence:**
- `high` - Solution thoroughly tested, all criteria passed
- `medium` - Works but limited edge case testing
- `low` - Workaround or partial solution

## Entry Creation

### 1. Create Directory

```bash
mkdir -p .tiki/knowledge/entries
```

### 2. Read/Initialize Index

Load `.tiki/knowledge/index.json` or create default:

```json
{
  "lastUpdated": "{ISO timestamp}",
  "nextId": 1,
  "entries": {}
}
```

### 3. Write Entry File

Format ID as `K{NNN}` (padded to 3 digits). Create `.tiki/knowledge/entries/K{NNN}-{slug}.json`:

```json
{
  "id": "K{NNN}",
  "title": "{title}",
  "content": "{markdown content}",
  "created": "{ISO timestamp}",
  "source": {
    "type": "issue",
    "issueNumber": {N},
    "issueTitle": "{issue title}"
  },
  "keywords": ["{keyword1}", "{keyword2}"],
  "related": {
    "issues": [{N}],
    "files": ["{modified files}"]
  },
  "confidence": "{high|medium|low}",
  "autoGenerated": true
}
```

### 4. Update Index

Add entry to `.tiki/knowledge/index.json`:

```json
{
  "K{NNN}": {
    "title": "{title}",
    "created": "{ISO timestamp}",
    "source": "issue",
    "keywords": ["{keywords}"],
    "files": ["{paths}"],
    "confidence": "{level}",
    "autoGenerated": true
  }
}
```

Increment `nextId` after creation.

## Display Output

On success:
```
Knowledge captured: K{NNN} - {title}
```

On skip:
```
Knowledge capture skipped (no substantial learnings)
```

On error (warning only):
```
Note: Could not capture knowledge (see warnings above).
The issue was shipped successfully.
```

## Error Handling

- Index file corrupted: Log warning, skip capture
- Write permission denied: Log warning, skip capture
- Invalid plan structure: Log warning, skip capture

Never fail ship due to knowledge capture errors.
