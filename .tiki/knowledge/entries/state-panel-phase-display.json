{
  "id": "state-panel-phase-display",
  "title": "State Panel Phase Display Issues",
  "category": "troubleshooting",
  "createdAt": "2026-02-02T02:00:00.000Z",
  "tags": ["state-panel", "useTikiSync", "phases", "release-executions", "sidebar"],
  "content": "## Problem: State Panel Shows 'No active execution' During Plan Execution\n\n### Symptoms\n- State panel in sidebar shows 'Idle - No active execution'\n- Plan executes faithfully with all phases completing\n- Phases never display in the state panel UI\n\n### Root Causes Found\n\n#### Bug 1: Release Executions Filtered Out\n- `activeExecutions` array in `current.json` can contain release executions (type: 'release')\n- Release executions use `currentIssue` field instead of `issue` or `issueNumber`\n- The mapping code in `useTikiSync.ts` filtered out entries without `issue` or `issueNumber`\n- Result: `executions` array became empty, multi-execution mode never activated\n\n**Fix applied**: Updated filter to also check for `currentIssue`:\n```typescript\n.filter((exec) => exec.issue !== undefined || exec.issueNumber !== undefined || exec.currentIssue !== undefined)\n```\n\n#### Bug 2: Plan Not Loaded on Initial Load\n- `loadInitialData()` function only loaded state, releases, and queue\n- Never loaded the plan for the active issue\n- `currentPlan` was null until a plan file change event fired\n- Without `currentPlan`, phases couldn't be displayed even when state had activeIssue\n\n**Fix applied**: Added plan loading after state load:\n```typescript\nif (mappedState?.activeIssue) {\n  const planData = await window.tikiDesktop.tiki.getPlan(mappedState.activeIssue)\n  if (planData?.plan) {\n    setPlan(plan.issue.number, plan)\n    setCurrentPlan(plan)\n  }\n}\n```\n\n### Key Files\n- `src/renderer/src/hooks/useTikiSync.ts` - State sync hook (fixes applied here)\n- `src/renderer/src/components/layout/Sidebar.tsx` - State panel rendering (lines 378-489)\n- `.tiki/state/current.json` - Runtime state file\n- `.tiki/plans/issue-*.json` - Plan files\n\n### Sidebar Rendering Logic (for reference)\n```\nIF tikiState?.executions?.length > 0\n  -> Multi-execution mode (ExecutionItem components)\nELSE IF tikiState?.activeIssue\n  -> Legacy single-execution mode (needs currentPlan for phases)\nELSE IF currentPlan?.phases?.some(status in_progress|failed)\n  -> Plan-based fallback (amber indicator)\nELSE\n  -> 'No active execution' message\n```\n\n### What Hasn't Been Verified Yet\n- Whether fix works correctly during live execution (only analyzed post-completion state)\n- Whether multi-execution mode displays correctly with release + issue executions\n- Whether there are other field name mismatches between state file and store interfaces\n\n### Related Prior Work\n- Issue #107: 'State window not updating during execution - phase progress not displayed'\n- That fix added plan-based fallback but didn't address root cause of empty executions array",
  "relatedIssues": [118, 107]
}
